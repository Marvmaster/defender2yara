rule Exploit_MacOS_DirtyCow_C_2147839942_0
{
    meta:
        author = "defender2yara"
        detection_name = "Exploit:MacOS/DirtyCow.C!MTB"
        threat_id = "2147839942"
        type = "Exploit"
        platform = "MacOS: "
        family = "DirtyCow"
        severity = "Critical"
        info = "MTB: Microsoft Threat Behavior"
        signature_type = "SIGNATURE_TYPE_MACHOHSTR_EXT"
        threshold = "6"
        strings_accuracy = "High"
    strings:
        $x_5_1 = {28 00 80 52 e8 43 03 39 e0 37 40 f9 01 00 80 d2 d0 1d 00 94 60 03 40 b9 e1 87 40 b9 7c 1d 00 94 60 03 40 b9 e1 83 40 b9 79 1d 00 94 60 03 40 b9 e2 3b 40 f9 e1 03 14 aa 2c 1e 00 94 60 03 40 b9 e1 2b 40 f9 e2 3b 40 f9 28 1e 00 94 40 03 40 f9 e9 17 40 f9 e8 1b 40 f9 e8 a7 00 a9 e8 1f 40 f9 e8 03 00 f9 81 ef 03 70 1f 20 03 d5 53 1d 00 94 40 03 40 f9 28 00 80 52 f3 23 00 a9 01 f1 03 70 1f 20 03 d5}  //weight: 5, accuracy: High
        $x_5_2 = {60 03 40 b9 e1 03 01 91 e2 03 14 aa 63 00 80 52 03 08 a0 72 e4 03 16 aa 05 00 80 52 ab 1e 00 94 e8 3b 40 f9 e8 23 00 f9 60 03 40 b9 e1 03 01 91 e2 03 14 aa 23 00 80 52 03 08 a0 72 e4 03 16 aa 05 00 80 52 a1 1e 00 94 e2 23 40 f9 e8 3b 40 f9 5f 00 08 eb 00 01 00 54 43 03 40 f9 40 11 04 70 1f 20 03 d5 a1 02 80 52 22 00 80 52 94 1e 00 94 e2 3b 40 f9}  //weight: 5, accuracy: High
        $x_1_3 = "vm_read_overwrite: KERN_SUCCESS:%d KERN_PROTECTION_FAILURE:%d other:%d" ascii //weight: 1
        $x_1_4 = "/usr/bin/sed -e \"s/rootok/permit/g\" /etc" ascii //weight: 1
        $x_1_5 = "vm_unaligned_copy_switch_race" ascii //weight: 1
        $x_1_6 = "Ran %d times in %ld seconds with no failure" ascii //weight: 1
        $x_1_7 = "DynamicCow/ContentView" ascii //weight: 1
        $x_1_8 = "camera_shutter_burst_end" ascii //weight: 1
        $x_1_9 = "com.apple.MobileGestalt.plist" ascii //weight: 1
        $x_1_10 = "_availability_version_check" ascii //weight: 1
    condition:
        (filesize < 20MB) and
        ((uint32(0) == 0xfeedfacf) or (uint32(0) == 0xcffaedfe) or (uint32(0) == 0xfeedface) or (uint32(0) == 0xcefaedfe)) and
        (
            ((6 of ($x_1_*))) or
            ((1 of ($x_5_*) and 1 of ($x_1_*))) or
            ((2 of ($x_5_*))) or
            (all of ($x*))
        )
}

rule Exploit_MacOS_DirtyCow_D_2147839943_0
{
    meta:
        author = "defender2yara"
        detection_name = "Exploit:MacOS/DirtyCow.D!MTB"
        threat_id = "2147839943"
        type = "Exploit"
        platform = "MacOS: "
        family = "DirtyCow"
        severity = "Critical"
        info = "MTB: Microsoft Threat Behavior"
        signature_type = "SIGNATURE_TYPE_MACHOHSTR_EXT"
        threshold = "4"
        strings_accuracy = "High"
    strings:
        $x_1_1 = "MacDirtyCow" ascii //weight: 1
        $x_1_2 = "camera_shutter_burst_end" ascii //weight: 1
        $x_1_3 = "vm_unaligned_copy_switch_race" ascii //weight: 1
        $x_1_4 = "Restart SpringBoard" ascii //weight: 1
        $x_1_5 = "ran %d times in %ld seconds with no failure" ascii //weight: 1
        $x_1_6 = "RO mapping was modified" ascii //weight: 1
    condition:
        (filesize < 20MB) and
        ((uint32(0) == 0xfeedfacf) or (uint32(0) == 0xcffaedfe) or (uint32(0) == 0xfeedface) or (uint32(0) == 0xcefaedfe)) and
        (4 of ($x*))
}

rule Exploit_MacOS_DirtyCow_E_2147839944_0
{
    meta:
        author = "defender2yara"
        detection_name = "Exploit:MacOS/DirtyCow.E!MTB"
        threat_id = "2147839944"
        type = "Exploit"
        platform = "MacOS: "
        family = "DirtyCow"
        severity = "Critical"
        info = "MTB: Microsoft Threat Behavior"
        signature_type = "SIGNATURE_TYPE_MACHOHSTR_EXT"
        threshold = "4"
        strings_accuracy = "High"
    strings:
        $x_1_1 = "vm_read_overwrite: KERN_SUCCESS:%d KERN_PROTECTION_FAILURE:%d other:%d" ascii //weight: 1
        $x_1_2 = "RO mapping was modified" ascii //weight: 1
        $x_1_3 = "Ran %d times in %ld seconds with no failure" ascii //weight: 1
        $x_1_4 = "SBDontLockAfterCrash" ascii //weight: 1
        $x_1_5 = "com.apple.mobilegestalt.plist" ascii //weight: 1
        $x_1_6 = "vm_unaligned_copy_switch_race" ascii //weight: 1
        $x_1_7 = "_switcheroo" ascii //weight: 1
    condition:
        (filesize < 20MB) and
        ((uint32(0) == 0xfeedfacf) or (uint32(0) == 0xcffaedfe) or (uint32(0) == 0xfeedface) or (uint32(0) == 0xcefaedfe)) and
        (4 of ($x*))
}

