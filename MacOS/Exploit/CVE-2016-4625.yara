rule Exploit_MacOS_CVE_2016_4625_A_2147796722_0
{
    meta:
        author = "defender2yara"
        detection_name = "Exploit:MacOS/CVE-2016-4625.A!MTB"
        threat_id = "2147796722"
        type = "Exploit"
        platform = "MacOS: "
        family = "CVE-2016-4625"
        severity = "Critical"
        info = "MTB: Microsoft Threat Behavior"
        signature_type = "SIGNATURE_TYPE_MACHOHSTR_EXT"
        threshold = "5"
        strings_accuracy = "High"
    strings:
        $x_1_1 = "child receiving stolen port" ascii //weight: 1
        $x_1_2 = "inserting MAKE_SEND into shared port" ascii //weight: 1
        $x_1_3 = "got user client" ascii //weight: 1
        $x_1_4 = "getting stashed port" ascii //weight: 1
        $x_1_5 = "killed child" ascii //weight: 1
    condition:
        (filesize < 20MB) and
        ((uint32(0) == 0xfeedfacf) or (uint32(0) == 0xcffaedfe) or (uint32(0) == 0xfeedface) or (uint32(0) == 0xcefaedfe)) and
        (all of ($x*))
}

rule Exploit_MacOS_CVE_2016_4625_A_2147816679_0
{
    meta:
        author = "defender2yara"
        detection_name = "Exploit:MacOS/CVE-2016-4625.A!xp"
        threat_id = "2147816679"
        type = "Exploit"
        platform = "MacOS: "
        family = "CVE-2016-4625"
        severity = "Critical"
        info = "xp: an internal category used to refer to some threats"
        signature_type = "SIGNATURE_TYPE_MACHOHSTR_EXT"
        threshold = "5"
        strings_accuracy = "High"
    strings:
        $x_1_1 = "/usr/sbin/traceroute6" ascii //weight: 1
        $x_1_2 = "allocated shellcode in target at %llx" ascii //weight: 1
        $x_1_3 = "inserting MAKE_SEND into shared port" ascii //weight: 1
        $x_1_4 = {8b 85 2c ff ff ff 83 f8 00 0f 85 2c 00 00 00 be fe 1b 00 00 b9 01 00 00 80 41 b8 0d 00 00 00 8b bd 48 ff ff ff 8b 95 44 ff ff ff e8 91 07 00 00 89 85 2c ff ff ff e9 c5 ff ff ff}  //weight: 1, accuracy: High
        $x_1_5 = "_sploit_child" ascii //weight: 1
        $x_1_6 = "_sploit_parent" ascii //weight: 1
        $x_1_7 = {48 8d 45 c8 b9 86 52 49 00 ba dc 75 25 00 be 60 cf fe 8c 48 8b 3d 29 0e 00 00 45 31 c0 41 b9 28 00 00 00 45 89 ca 49 89 c3 48 89 7d c0 4c 89 df 89 75 bc 44 89 c6 89 55 b8 4c 89 d2 48 89 45 b0 89 4d ac e8 45 08 00 00 c7 45 cc 28 00 00 00 8b 4d f4 89 4d d4 8b 4d fc 89 4d d0 c7 45 c8 13 15 00 80 c7 45 e0 01 00 00 00 48 8b 45 c0 8b 08 89 4d e4 8b 4d ec 8b 75 bc 81 c6 9f 30 02 72 21 f1 8b 75 b8 81 ee dc 75 12 00 09 f1 89 4d ec 8b 4d ec 8b 75 ac 44 6b c6 03 44 21 c1 89 4d ec 48 8b 7d b0 e8 b6 07 00 00 89 45 f8 83 7d f8 00}  //weight: 1, accuracy: High
    condition:
        (filesize < 20MB) and
        ((uint32(0) == 0xfeedfacf) or (uint32(0) == 0xcffaedfe) or (uint32(0) == 0xfeedface) or (uint32(0) == 0xcefaedfe)) and
        (5 of ($x*))
}

