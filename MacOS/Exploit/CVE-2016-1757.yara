rule Exploit_MacOS_CVE_2016_1757_A_2147816673_0
{
    meta:
        author = "defender2yara"
        detection_name = "Exploit:MacOS/CVE-2016-1757.A!xp"
        threat_id = "2147816673"
        type = "Exploit"
        platform = "MacOS: "
        family = "CVE-2016-1757"
        severity = "Critical"
        info = "xp: an internal category used to refer to some threats"
        signature_type = "SIGNATURE_TYPE_MACHOHSTR_EXT"
        threshold = "4"
        strings_accuracy = "Low"
    strings:
        $x_1_1 = "rm -rf /library/extensions/acs6x.kext" ascii //weight: 1
        $x_1_2 = {c7 85 74 ff ff ff 09 00 00 00 c7 85 70 ff ff ff 00 00 00 00 48 c7 85 68 ff ff ff 00 10 00 00 48 c7 85 38 ff ff ff 00 00 00 00 48 [0-16] 24 b9 09 00 00 00 44 89 ff 48 8d b5 38 ff ff ff [0-8] 4d 89 e8 4d 89 f1 e8 ?? 02 00 00 48 8b 9d 38 ff ff ff 48 8b 85 60 ff ff ff 48 89 d9 48 c1 e9 21 75 ?? 48 39 c3 74 ?? 48 03 1d ?? 0b 00 00 ?? 8b 35 ?? 0b 00 00 [0-3] 31 c9 41 b8 07 00 00 00 44 89 ff 48 89 de [0-3] e8 ?? 02 00 00 48 8b 15 ?? 0b 00 00 44 89 ff 48 89 de 44 89 f1 e8 ?? 02 00 00 48 81 c4 a8 00 00 00 5b}  //weight: 1, accuracy: Low
        $x_1_3 = "child restored stolen port" ascii //weight: 1
        $x_1_4 = {48 8d 3d 4c 0c 00 00 e8 17 07 00 00 0f 57 c0 0f 29 45 c0 0f 29 45 b0 0f 29 45 a0 44 8b 45 f0 c7 04 24 00 00 00 00 48 8d 7d a0 be 02 00 00 00 31 d2 b9 30 00 00 00 45 31 c9 e8 af 06 00 00 85 c0 75 48 8b 55 bc 85 d2 74 4a 8b 3b be 04 00 00 00 e8 e6 06 00 00 85 c0 75 50 48 8d 3d 33 0c 00 00 e8 be 06 00 00 8b 45 f4 48 83 c4 68 5b 5d c3}  //weight: 1, accuracy: High
    condition:
        (filesize < 20MB) and
        ((uint32(0) == 0xfeedfacf) or (uint32(0) == 0xcffaedfe) or (uint32(0) == 0xfeedface) or (uint32(0) == 0xcefaedfe)) and
        (all of ($x*))
}

rule Exploit_MacOS_CVE_2016_1757_B_2147816674_0
{
    meta:
        author = "defender2yara"
        detection_name = "Exploit:MacOS/CVE-2016-1757.B!xp"
        threat_id = "2147816674"
        type = "Exploit"
        platform = "MacOS: "
        family = "CVE-2016-1757"
        severity = "Critical"
        info = "xp: an internal category used to refer to some threats"
        signature_type = "SIGNATURE_TYPE_MACHOHSTR_EXT"
        threshold = "2"
        strings_accuracy = "High"
    strings:
        $x_1_1 = {48 8d 35 86 0a 00 00 48 8b 05 73 0d 00 00 48 8b 0d 7c 0d 00 00 48 8d 95 30 ff ff ff 48 89 95 20 ff ff ff 48 8b 95 20 ff ff ff c7 02 13 14 00 00 48 8b 95 20 ff ff ff 8b 3a 81 cf 00 00 00 80 89 3a 48 8b 95 20 ff ff ff c7 42 04 28 00 00 00 8b bd 18 ff ff ff 48 8b 95 20 ff ff ff 89 7a 08 8b bd 1c ff ff ff 48 8b 95 20 ff ff ff 89 7a 0c 48 8b 95 20 ff ff ff c7 42 10 00 00 00 00 48 8b 95 20 ff ff ff c7 42 14 90 01 00 00 c7 85 48 ff ff ff 01 00 00 00 8b 39 89 bd 4c ff ff ff 8b bd 54 ff ff ff 81 e7 ff ff 00 ff 81 cf 00 00 13 00 89 bd 54 ff ff ff 8b bd 54 ff ff ff 81 e7 ff ff ff 00 89 bd 54 ff ff ff c7 85 14 ff ff ff 01 00 00 00 48 8b 38}  //weight: 1, accuracy: High
        $x_1_2 = {41 b0 02 49 c1 e0 18 49 83 c8 17 31 ff 4c 89 c0 0f 05 eb 12 5f 49 83 c0 24 4c 89 c0 48 31 d2 52 57 48 89 e6 0f 05 e8 e9 ff ff ff 2f 62 69 6e 2f 2f 73 68}  //weight: 1, accuracy: High
        $x_1_3 = {31 c0 50 50 b0 17 cd 80 eb 0c 5b 31 c0 50 50 53 b0 3b 50 cd 80 c3 e8 ef ff ff ff 2f 62 69 6e 2f 73 68}  //weight: 1, accuracy: High
        $x_1_4 = "com.put.as.mach_race" ascii //weight: 1
        $x_1_5 = "Target entrypoint is 0x%llx" ascii //weight: 1
    condition:
        (filesize < 20MB) and
        ((uint32(0) == 0xfeedfacf) or (uint32(0) == 0xcffaedfe) or (uint32(0) == 0xfeedface) or (uint32(0) == 0xcefaedfe)) and
        (2 of ($x*))
}

