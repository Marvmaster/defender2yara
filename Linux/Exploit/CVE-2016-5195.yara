rule Exploit_Linux_CVE_2016_5195_A_2147759684_0
{
    meta:
        author = "defender2yara"
        detection_name = "Exploit:Linux/CVE-2016-5195.A!MTB"
        threat_id = "2147759684"
        type = "Exploit"
        platform = "Linux: Linux platform"
        family = "CVE-2016-5195"
        severity = "Critical"
        info = "MTB: Microsoft Threat Behavior"
        signature_type = "SIGNATURE_TYPE_ELFHSTR_EXT"
        threshold = "4"
        strings_accuracy = "High"
    strings:
        $x_2_1 = "backdoor" ascii //weight: 2
        $x_1_2 = "waiting for reverse connect shell" ascii //weight: 1
        $x_1_3 = "exploit failed" ascii //weight: 1
        $x_1_4 = "vdso successfully" ascii //weight: 1
        $x_1_5 = "/tmp/.x" ascii //weight: 1
    condition:
        (filesize < 20MB) and
        (uint32(0) == 0x464c457f) and
        (
            ((4 of ($x_1_*))) or
            ((1 of ($x_2_*) and 2 of ($x_1_*))) or
            (all of ($x*))
        )
}

rule Exploit_Linux_CVE_2016_5195_C_2147816818_0
{
    meta:
        author = "defender2yara"
        detection_name = "Exploit:Linux/CVE-2016-5195.C!xp"
        threat_id = "2147816818"
        type = "Exploit"
        platform = "Linux: Linux platform"
        family = "CVE-2016-5195"
        severity = "Critical"
        info = "xp: an internal category used to refer to some threats"
        signature_type = "SIGNATURE_TYPE_ELFHSTR_EXT"
        threshold = "5"
        strings_accuracy = "Low"
    strings:
        $x_2_1 = {2f 74 6d 70 2f [0-37] 2e 62 61 6b}  //weight: 2, accuracy: Low
        $x_1_2 = "madvise" ascii //weight: 1
        $x_1_3 = "DON'T FORGET TO RESTORE" ascii //weight: 1
        $x_2_4 = {64 69 72 74 79 [0-37] 2e 63}  //weight: 2, accuracy: Low
        $x_1_5 = "successfully backed up to" ascii //weight: 1
        $x_1_6 = "procselfmem" ascii //weight: 1
        $x_1_7 = "madviseThread" ascii //weight: 1
    condition:
        (filesize < 20MB) and
        (uint32(0) == 0x464c457f) and
        (
            ((5 of ($x_1_*))) or
            ((1 of ($x_2_*) and 3 of ($x_1_*))) or
            ((2 of ($x_2_*) and 1 of ($x_1_*))) or
            (all of ($x*))
        )
}

rule Exploit_Linux_CVE_2016_5195_D_2147818656_0
{
    meta:
        author = "defender2yara"
        detection_name = "Exploit:Linux/CVE-2016-5195.D!MTB"
        threat_id = "2147818656"
        type = "Exploit"
        platform = "Linux: Linux platform"
        family = "CVE-2016-5195"
        severity = "Critical"
        info = "MTB: Microsoft Threat Behavior"
        signature_type = "SIGNATURE_TYPE_ELFHSTR_EXT"
        threshold = "5"
        strings_accuracy = "High"
    strings:
        $x_2_1 = "/default.prop /data/local/tmp/default.prop" ascii //weight: 2
        $x_1_2 = "madvise = %p %d" ascii //weight: 1
        $x_1_3 = "/proc/self/mem %d %i" ascii //weight: 1
        $x_1_4 = "dirtycow" ascii //weight: 1
    condition:
        (filesize < 20MB) and
        (uint32(0) == 0x464c457f) and
        (all of ($x*))
}

rule Exploit_Linux_CVE_2016_5195_M_2147909035_0
{
    meta:
        author = "defender2yara"
        detection_name = "Exploit:Linux/CVE-2016-5195.M!MTB"
        threat_id = "2147909035"
        type = "Exploit"
        platform = "Linux: Linux platform"
        family = "CVE-2016-5195"
        severity = "Critical"
        info = "MTB: Microsoft Threat Behavior"
        signature_type = "SIGNATURE_TYPE_ELFHSTR_EXT"
        threshold = "3"
        strings_accuracy = "High"
    strings:
        $x_1_1 = {eb 4a 48 8b 05 36 08 20 00 48 89 c1 8b 45 ec ba 00 00 00 00 48 89 ce 89 c7 e8 d9 fd ff ff 48 8b 45 f0 48 89 c7 e8 9d fd ff ff 48 89 c2 48 8b 4d f0 8b 45 ec 48 89 ce 89 c7 e8 79 fd ff ff 89 c2 8b 45 f8 01 d0 89 45 f8 83 45 fc 01 81 7d fc ff e0 f5 05}  //weight: 1, accuracy: High
        $x_1_2 = {74 1e 0f 1f 84 00 00 00 00 00 4c 89 ea 4c 89 f6 44 89 ff 41 ff 14 dc 48 83 c3 01 48 39 eb 75 ea 48 83 c4 08}  //weight: 1, accuracy: High
        $x_1_3 = "dirtyc0w target_file new_content" ascii //weight: 1
    condition:
        (filesize < 20MB) and
        (uint32(0) == 0x464c457f) and
        (all of ($x*))
}

