rule Exploit_Linux_CVE_2021_4034_B_2147812799_0
{
    meta:
        author = "defender2yara"
        detection_name = "Exploit:Linux/CVE-2021-4034.B!MTB"
        threat_id = "2147812799"
        type = "Exploit"
        platform = "Linux: Linux platform"
        family = "CVE-2021-4034"
        severity = "Critical"
        info = "MTB: Microsoft Threat Behavior"
        signature_type = "SIGNATURE_TYPE_ELFHSTR_EXT"
        threshold = "2"
        strings_accuracy = "Low"
    strings:
        $x_2_1 = {48 89 e5 bf 00 00 00 00 e8 ?? ?? ff ff bf 00 00 00 00 e8 ?? ?? ff ff bf 00 00 00 00 b8 00 00 00 00 e8 ?? ?? ff ff ba 00 00 00 00 be 00 00 00 00 48 8d 3d ?? ?? 00 00}  //weight: 2, accuracy: Low
        $x_2_2 = {48 89 7d d8 48 8d 05 ?? ?? 00 00 48 89 45 f0 48 c7 45 f8 00 00 00 00 48 8d 05 ?? ?? 00 00 48 89 45 e0 48 c7 45 e8 00 00 00 00 bf 00 00 00 00 e8 b9 ?? ?? ff bf 00 00 00 00 e8 8f ?? ?? ff 48 8b 45 f0 48 8d 55 e0 48 8d 4d f0 48 89 ce 48 89 c7 e8 58 ?? ?? ff bf 00 00 00 00}  //weight: 2, accuracy: Low
    condition:
        (filesize < 20MB) and
        (uint32(0) == 0x464c457f) and
        (1 of ($x*))
}

rule Exploit_Linux_CVE_2021_4034_A_2147813831_0
{
    meta:
        author = "defender2yara"
        detection_name = "Exploit:Linux/CVE-2021-4034.A!MTB"
        threat_id = "2147813831"
        type = "Exploit"
        platform = "Linux: Linux platform"
        family = "CVE-2021-4034"
        severity = "Critical"
        info = "MTB: Microsoft Threat Behavior"
        signature_type = "SIGNATURE_TYPE_ELFHSTR_EXT"
        threshold = "2"
        strings_accuracy = "High"
    strings:
        $x_2_1 = {48 89 e5 48 83 ec 20 64 48 8b 04 25 28 00 00 00 48 89 45 f8 31 c0 e8 a7 fe ff ff 85 c0 0f 85 8d 00 00 00 48 8b 05 90 2d 00 00 48 8b 00 48 89 c1 ba 07 00 00 00 be 01 00 00 00 48 8d 3d 81 0d 00 00 e8 cc fe ff ff bf 00 00 00 00 e8 d2 fe ff ff bf 00 00 00 00 e8 88 fe ff ff bf 00 00 00 00 e8 ce fe ff ff ba 01 00 00 00 48 8d 35 5a 0d 00 00 48 8d 3d 70 0d 00 00 e8 26 fe ff ff 48 8d 05 69 0d 00 00 48 89 45 e0 48 c7 45 e8 00 00 00 00 48 8d 45 e0 48 89 c6 48 8d 3d 4f 0d 00 00 e8 60 fe ff ff 48 8d 3d 46 0d 00 00 e8 44 fe ff ff eb 23}  //weight: 2, accuracy: High
        $x_2_2 = {48 89 e5 48 83 ec 30 48 89 7d d8 48 8d 05 ad 0e 00 00 48 89 45 f0 48 c7 45 f8 00 00 00 00 48 8d 05 a2 0e 00 00 48 89 45 e0 48 c7 45 e8 00 00 00 00 bf 00 00 00 00 e8 e4 fe ff ff bf 00 00 00 00 e8 ba fe ff ff 48 8b 45 f0 48 8d 55 e0 48 8d 4d f0 48 89 ce 48 89 c7 e8 93 fe ff ff bf 00 00 00 00 e8 a9 fe ff ff}  //weight: 2, accuracy: High
        $x_2_3 = {48 89 e5 bf 00 00 00 00 e8 12 ff ff ff bf 00 00 00 00 e8 f8 fe ff ff bf 00 00 00 00 b8 00 00 00 00 e8 c9 fe ff ff ba 00 00 00 00 be 00 00 00 00 48 8d 05 88 0e 00 00 48 89 c7 e8 c0 fe ff ff 90 5d c3}  //weight: 2, accuracy: High
        $x_2_4 = {48 89 e5 48 83 ec 40 48 89 7d c8 64 48 8b 04 25 28 00 00 00 48 89 45 f8 31 c0 48 8d 05 56 0e 00 00 48 89 45 d0 48 c7 45 d8 00 00 00 00 48 8d 05 4b 0e 00 00 48 89 45 e0 48 c7 45 e8 00 00 00 00 bf 00 00 00 00 e8 dd fe ff ff bf 00 00 00 00 e8 b3 fe ff ff 48 8b 45 d0 48 8d 55 e0 48 8d 4d d0 48 89 ce 48 89 c7 e8 8c fe ff ff bf 00 00 00 00}  //weight: 2, accuracy: High
    condition:
        (filesize < 20MB) and
        (uint32(0) == 0x464c457f) and
        (1 of ($x*))
}

rule Exploit_Linux_CVE_2021_4034_A_2147814507_0
{
    meta:
        author = "defender2yara"
        detection_name = "Exploit:Linux/CVE-2021-4034.A"
        threat_id = "2147814507"
        type = "Exploit"
        platform = "Linux: Linux platform"
        family = "CVE-2021-4034"
        severity = "Critical"
        signature_type = "SIGNATURE_TYPE_ELFHSTR_EXT"
        threshold = "12"
        strings_accuracy = "High"
    strings:
        $x_10_1 = "PATH=GCONV_PATH=" ascii //weight: 10
        $x_1_2 = "/usr/bin/pkexec" ascii //weight: 1
        $x_1_3 = "execve" ascii //weight: 1
    condition:
        (filesize < 20MB) and
        (uint32(0) == 0x464c457f) and
        (all of ($x*))
}

rule Exploit_Linux_CVE_2021_4034_C_2147820419_0
{
    meta:
        author = "defender2yara"
        detection_name = "Exploit:Linux/CVE-2021-4034.C!MTB"
        threat_id = "2147820419"
        type = "Exploit"
        platform = "Linux: Linux platform"
        family = "CVE-2021-4034"
        severity = "Critical"
        info = "MTB: Microsoft Threat Behavior"
        signature_type = "SIGNATURE_TYPE_ELFHSTR_EXT"
        threshold = "1"
        strings_accuracy = "High"
    strings:
        $x_1_1 = {72 2f 62 69 6e 3a 2f 62 69 6e 00 50 41 54 48 00 73 68 00 65 78 65 63 76 70 20 66 61 69 6c 65 64 00 46 61 69 6c 65 64 20 3a 28 0a}  //weight: 1, accuracy: High
        $x_1_2 = {63 20 2d 6f 20 70 61 79 6c 6f 61 64 2e 73 6f 20 2d 73 68 61 72 65 64 20 2d 66 50 49 43 20 70 61 79 6c 6f 61 64 2e 63 00}  //weight: 1, accuracy: High
    condition:
        (filesize < 20MB) and
        (uint32(0) == 0x464c457f) and
        (1 of ($x*))
}

rule Exploit_Linux_CVE_2021_4034_G_2147913715_0
{
    meta:
        author = "defender2yara"
        detection_name = "Exploit:Linux/CVE-2021-4034.G!MTB"
        threat_id = "2147913715"
        type = "Exploit"
        platform = "Linux: Linux platform"
        family = "CVE-2021-4034"
        severity = "Critical"
        info = "MTB: Microsoft Threat Behavior"
        signature_type = "SIGNATURE_TYPE_ELFHSTR_EXT"
        threshold = "2"
        strings_accuracy = "High"
    strings:
        $x_1_1 = {48 8b 45 e8 48 c1 e0 1e 48 89 c2 48 b8 00 00 00 00 00 01 00 00 48 01 d0 c6 00 41 48 83 45 e8 01 48 83 7d e8 1e 76 d9}  //weight: 1, accuracy: High
        $x_1_2 = {48 8b 45 f8 48 8d 50 02 48 89 55 f8 0f b7 00 0f b7 c0 01 45 f4 83 6d e4 02 83 7d e4 01 77 e1}  //weight: 1, accuracy: High
    condition:
        (filesize < 20MB) and
        (uint32(0) == 0x464c457f) and
        (all of ($x*))
}

