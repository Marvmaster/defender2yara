rule Exploit_Linux_CVE_2021_3490_A_2147900564_0
{
    meta:
        author = "defender2yara"
        detection_name = "Exploit:Linux/CVE-2021-3490.A!MTB"
        threat_id = "2147900564"
        type = "Exploit"
        platform = "Linux: Linux platform"
        family = "CVE-2021-3490"
        severity = "Critical"
        info = "MTB: Microsoft Threat Behavior"
        signature_type = "SIGNATURE_TYPE_ELFHSTR_EXT"
        threshold = "6"
        strings_accuracy = "High"
    strings:
        $x_1_1 = "ch0mpie" ascii //weight: 1
        $x_1_2 = "exploit.c" ascii //weight: 1
        $x_1_3 = "run_bpf_prog" ascii //weight: 1
        $x_1_4 = "overwrite_cred" ascii //weight: 1
        $x_1_5 = "prepare_kernel_write" ascii //weight: 1
        $x_1_6 = "create_bpf_maps" ascii //weight: 1
    condition:
        (filesize < 20MB) and
        (uint32(0) == 0x464c457f) and
        (all of ($x*))
}

rule Exploit_Linux_CVE_2021_3490_C_2147902343_0
{
    meta:
        author = "defender2yara"
        detection_name = "Exploit:Linux/CVE-2021-3490.C!MTB"
        threat_id = "2147902343"
        type = "Exploit"
        platform = "Linux: Linux platform"
        family = "CVE-2021-3490"
        severity = "Critical"
        info = "MTB: Microsoft Threat Behavior"
        signature_type = "SIGNATURE_TYPE_ELFHSTR_EXT"
        threshold = "9"
        strings_accuracy = "High"
    strings:
        $x_1_1 = "frame_dummy_init_array_entry" ascii //weight: 1
        $x_1_2 = "leak_oob_map_ptr" ascii //weight: 1
        $x_1_3 = "overwrite_cred" ascii //weight: 1
        $x_1_4 = "obj_get_info_by_fd" ascii //weight: 1
        $x_1_5 = "kernel_write_uint" ascii //weight: 1
        $x_1_6 = "search_init_pid_ns_kstrtab" ascii //weight: 1
        $x_1_7 = "search_init_pid_ns_ksymtab" ascii //weight: 1
        $x_1_8 = "failed to leak ptr to BPF map" ascii //weight: 1
        $x_1_9 = "preparing to overwrite creds..." ascii //weight: 1
        $x_1_10 = "success! enjoy r00t" ascii //weight: 1
        $x_1_11 = "Useage: %s <path to program to execute as root>" ascii //weight: 1
        $x_1_12 = "searching for init_pid_ns in ksymtab" ascii //weight: 1
    condition:
        (filesize < 20MB) and
        (uint32(0) == 0x464c457f) and
        (9 of ($x*))
}

