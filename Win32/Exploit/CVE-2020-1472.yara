rule Exploit_Win32_CVE_2020_1472_A_2147774231_0
{
    meta:
        author = "defender2yara"
        detection_name = "Exploit:Win32/CVE-2020-1472.A!ibt"
        threat_id = "2147774231"
        type = "Exploit"
        platform = "Win32: Windows 32-bit platform"
        family = "CVE-2020-1472"
        severity = "Critical"
        info = "ibt: an internal category used to refer to some threats"
        signature_type = "SIGNATURE_TYPE_PEHSTR_EXT"
        threshold = "22"
        strings_accuracy = "Low"
    strings:
        $x_1_1 = "netserverauthenticate2 error" ascii //weight: 1
        $x_1_2 = "netrserverauthenticate2: STATUS_NO_TRUST_SAM_ACCOUNT" ascii //weight: 1
        $x_1_3 = "ncacn_ip_tcp" ascii //weight: 1
        $x_10_4 = {81 bd a0 fd ff ff d0 07 00 00 0f 8d 51 01 00 00 8d 45 b4 50 8d 4d cc 51 68 e8 cb 42 00 6a 00 e8 02 ea ff ff 83 c4 10 89 85 a8 fd ff ff 83 bd a8 fd ff ff 00 0f 85 13 01 00 00 8d 95 80 fd ff ff 52 8d 45 c0 50 8d 4d d8 51 68 ?? ?? ?? 00 8b 95 90 fd ff ff 52 68 28 c0 42 00}  //weight: 10, accuracy: Low
        $x_10_5 = {8d 45 08 50 b9 01 00 00 00 6b d1 00 81 c2 ?? ?? ?? 00 52 68 c8 a8 42 00 ff 15 7c 01 42 00 83 c4 0c 89 45 fc 8b 45 fc 8b e5 5d c3}  //weight: 10, accuracy: Low
    condition:
        (filesize < 20MB) and
        (uint16(0) == 0x5a4d) and
        (
            ((2 of ($x_10_*) and 2 of ($x_1_*))) or
            (all of ($x*))
        )
}

rule Exploit_Win32_CVE_2020_1472_B_2147774232_0
{
    meta:
        author = "defender2yara"
        detection_name = "Exploit:Win32/CVE-2020-1472.B!ibt"
        threat_id = "2147774232"
        type = "Exploit"
        platform = "Win32: Windows 32-bit platform"
        family = "CVE-2020-1472"
        severity = "Critical"
        info = "ibt: an internal category used to refer to some threats"
        signature_type = "SIGNATURE_TYPE_PEHSTR"
        threshold = "6"
        strings_accuracy = "High"
    strings:
        $x_1_1 = "netrserverauthenticate2: STATUS_NO_TRUST_SAM_ACCOUNT" ascii //weight: 1
        $x_1_2 = "ZERO.EXE IP DC DOMAIN ADMIN_USERNAME [-c] COMMAND" ascii //weight: 1
        $x_1_3 = "ncacn_ip_tcp" ascii //weight: 1
        $x_1_4 = "DomainControllerInfo not found" ascii //weight: 1
        $x_1_5 = "powershell.exe -c Reset-ComputerMachinePassword" ascii //weight: 1
        $x_1_6 = "server passwd set successfully" ascii //weight: 1
    condition:
        (filesize < 20MB) and
        (uint16(0) == 0x5a4d) and
        (all of ($x*))
}

