rule Exploit_Win32_RpcDcom_2147555612_0
{
    meta:
        author = "defender2yara"
        detection_name = "Exploit:Win32/RpcDcom"
        threat_id = "2147555612"
        type = "Exploit"
        platform = "Win32: Windows 32-bit platform"
        family = "RpcDcom"
        severity = "Critical"
        signature_type = "SIGNATURE_TYPE_PEHSTR"
        threshold = "3"
        strings_accuracy = "High"
    strings:
        $x_1_1 = "tftp -i %s GET %s" ascii //weight: 1
        $x_1_2 = "\\\\\\C$\\123456111111111111" wide //weight: 1
        $x_2_3 = {eb 19 5e 31 c9 81 e9 89 ff ff ff 81 36 80 bf 32 94 81 ee fc ff ff ff e2 f2 eb 05 e8 e2 ff ff ff 03 53 06 1f 74 57 75 95 80 bf bb 92 7f 89 5a 1a}  //weight: 2, accuracy: High
        $x_2_4 = {eb 10 5a 4a 33 c9 66 b9 76 01 80 34 0a 99 e2 fa eb 05 e8 eb ff ff ff 70 61 99 99 99 c3 21 95 69}  //weight: 2, accuracy: High
        $x_1_5 = {46 00 58 00 4e 00 42 00 46 00 58 00 46 00 58 00 4e 00 42 00 46 00 58 00 46 00 58 00 46 00 58 00 46 00 58 00 ff ff ff ff}  //weight: 1, accuracy: High
        $x_2_6 = {80 34 0a 99 e2 fa eb 05 e8}  //weight: 2, accuracy: High
        $x_2_7 = {31 00 32 00 37 00 2e 00 30 00 2e 00 30 00 2e 00 31 00 5c 00 49 00 50 00 43 00 24 00 5c 00 45 45}  //weight: 2, accuracy: High
        $x_1_8 = {5c 00 43 00 24 00 5c 00 31 00 32 00 33 00 34 00 35 00 36 00 31 00 31 00 31 00 31 00 31 00 31 00 31 00 31 00 31 00 31 00 31 00 31 00 31 00 31 00 31 00 2e 00 64 00 6f 00 63}  //weight: 1, accuracy: High
    condition:
        (filesize < 20MB) and
        (uint16(0) == 0x5a4d) and
        (
            ((3 of ($x_1_*))) or
            ((1 of ($x_2_*) and 1 of ($x_1_*))) or
            ((2 of ($x_2_*))) or
            (all of ($x*))
        )
}

rule Exploit_Win32_RpcDcom_MS03_039_2147599563_0
{
    meta:
        author = "defender2yara"
        detection_name = "Exploit:Win32/RpcDcom.gen!MS03-039"
        threat_id = "2147599563"
        type = "Exploit"
        platform = "Win32: Windows 32-bit platform"
        family = "RpcDcom"
        severity = "Critical"
        info = "gen: malware that is detected using a generic signature"
        signature_type = "SIGNATURE_TYPE_PEHSTR"
        threshold = "8"
        strings_accuracy = "High"
    strings:
        $x_1_1 = {00 00 00 05 00 00 03 10 00 00 00 e8 03 00 00 e5 00 00 00 d0 03 00 00 01 00 04 00 05 00 06 00 01 00 00 00 00 00 00 00 32 24 58 fd cc 45 64 49 b0 70 dd ae 74 2c 96 d2 60 5e 0d 00 01 00 00 00 00 00 00 00 70 5e 0d 00 02 00 00 00 7c 5e 0d 00 00 00 00 00 10 00 00 00 80 96 f1 f1 2a 4d ce 11 a6 6a 00 20 af 6e 72 f4 0c 00 00 00 4d 41 52 42 01 00 00 00 00 00 00 00 0d f0 ad ba 00 00 00 00 a8}  //weight: 1, accuracy: High
        $x_1_2 = {f4 0b 00 60 03 00 00 60 03 00 00 4d 45 4f 57 04 00 00 00 a2 01 00 00 00 00 00 00 c0 00 00 00 00 00 00 46 38 03 00 00 00 00 00 00 c0 00 00 00 00 00 00 46 00 00 00 00 30 03 00 00 28 03 00 00 00 00 00 00 01 10 08 00 cc cc cc cc c8 00 00 00 4d 45 4f 57 28 03 00 00 d8 00 00 00 00 00 00 00 02 00 00 00 07 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 c4 28 cd 00 64 29 cd 00 00}  //weight: 1, accuracy: High
        $x_1_3 = {00 00 00 07 00 00 00 b9 01 00 00 00 00 00 00 c0 00 00 00 00 00 00 46 ab 01 00 00 00 00 00 00 c0 00 00 00 00 00 00 46 a5 01 00 00 00 00 00 00 c0 00 00 00 00 00 00 46 a6 01 00 00 00 00 00 00 c0 00 00 00 00 00 00 46 a4 01 00 00 00 00 00 00 c0 00 00 00 00 00 00 46 ad 01 00 00 00 00 00 00 c0 00 00 00 00 00 00 46 aa 01 00 00 00 00 00 00 c0 00 00 00 00 00 00 46 07 00 00 00 60 00 00 00 58}  //weight: 1, accuracy: High
        $x_1_4 = {00 00 00 90 00 00 00 40 00 00 00 20 00 00 00 78 00 00 00 30 00 00 00 01 00 00 00 01 10 08 00 cc cc cc cc 50 00 00 00 4f b6 88 20 ff ff ff ff 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 10 08 00 cc}  //weight: 1, accuracy: High
        $x_1_5 = {cc cc cc 48 00 00 00 07 00 66 00 06 09 02 00 00 00 00 00 c0 00 00 00 00 00 00 46 10 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 78 19 0c 00 58 00 00 00 05 00 06 00 01 00 00 00 70 d8 98 93 98 4f d2 11 a9 3d be 57 b2 00 00 00 32 00 31 00 01 10 08 00 cc cc cc cc 80 00 00 00 0d f0 ad ba 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 18 43 14 00 00 00 00 00 60 00 00 00 60}  //weight: 1, accuracy: High
        $x_1_6 = {00 00 00 4d 45 4f 57 04 00 00 00 c0 01 00 00 00 00 00 00 c0 00 00 00 00 00 00 46 3b 03 00 00 00 00 00 00 c0 00 00 00 00 00 00 46 00 00 00 00 30 00 00 00 01 00 01 00 81 c5 17 03 80 0e e9 4a 99 99 f1 8a 50 6f 7a 85 02 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 01 10 08 00 cc cc cc cc 30 00 00 00 78 00 6e 00 00 00 00 00 d8 da 0d 00 00 00 00 00 00}  //weight: 1, accuracy: High
        $x_1_7 = {00 00 00 20 2f 0c 00 00 00 00 00 00 00 00 00 03 00 00 00 00 00 00 00 03 00 00 00 46 00 58 00 00 00 00 00 01 10 08 00 cc cc cc cc 10 00 00 00 30 00 2e 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 10 08 00 cc cc cc cc 68 00 00 00 0e 00 ff ff 68 8b 0b 00 02 00 00 00 00 00 00 00 00}  //weight: 1, accuracy: High
        $x_1_8 = "123456111111111111111.doc" wide //weight: 1
    condition:
        (filesize < 20MB) and
        (uint16(0) == 0x5a4d) and
        (all of ($x*))
}

